<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Manager v6.6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
        import { Octokit } from "https://esm.sh/@octokit/core";
        window.Octokit = Octokit;
    </script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { slate: { 850: '#15202e', 900: '#0f172a' }, darkbg: '#0B1120' },
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #94a3b8; border-radius: 20px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #475569; }
        
        /* [FIXED] Force hide uncompiled content to prevent flash of modal */
        [v-cloak] { display: none !important; }
        
        /* Markdown Styles */
        .markdown-body h2 { border-bottom: 1px solid #334155; padding-bottom: 0.5rem; margin-top: 1.5rem; margin-bottom: 1rem; font-size: 1.25rem; font-weight: 600; color: #e2e8f0; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5rem; color: #cbd5e1; }
        .markdown-body li { margin-bottom: 0.25rem; }
        .markdown-body code { background: #1e293b; padding: 0.2rem 0.4rem; rounded: 0.25rem; font-size: 0.875em; color: #cbd5e1; }

        /* Modern JSON Tree Styles */
        .json-tree { font-family: 'JetBrains Mono', monospace; font-size: 13px; line-height: 1.6; }
        .json-tree details { margin-left: 15px; }
        .json-tree summary { cursor: pointer; list-style: none; outline: none; display: flex; align-items: center; }
        .json-tree summary::-webkit-details-marker { display: none; }
        .json-tree summary:hover { background-color: rgba(255,255,255,0.05); border-radius: 4px; }
        
        .json-arrow { 
            display: inline-flex; justify-content: center; align-items: center;
            width: 14px; height: 14px; margin-right: 4px; 
            font-size: 8px; color: #64748b; transition: transform 0.2s; 
        }
        details[open] > summary > .json-arrow { transform: rotate(90deg); }

        .j-key { color: #60a5fa; font-weight: 600; }   
        .j-str { color: #34d399; }                      
        .j-num { color: #c084fc; }                      
        .j-bool { color: #f87171; }                     
        .j-null { color: #94a3b8; font-style: italic; } 
        .j-meta { color: #64748b; }                     

        /* Transitions */
        .toast-enter-active, .toast-leave-active { transition: all 0.3s ease; }
        .toast-enter-from, .toast-leave-to { opacity: 0; transform: translateY(20px); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-darkbg text-slate-800 dark:text-slate-200 h-screen overflow-hidden flex flex-col transition-colors duration-300">

<div id="app" class="h-full flex flex-col" v-cloak>

    <transition name="fade">
        <div v-if="modal.show" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
            <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden transform transition-all">
                <div class="p-6 pb-2">
                    <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-1 flex items-center gap-2">
                        <span class="text-xl">{{ modal.type === 'BLOCK' ? '‚õî Block Threat' : '‚ôªÔ∏è Manage Blocked Item' }}</span>
                    </h3>
                    <p class="text-xs text-slate-500 font-mono break-all bg-slate-100 dark:bg-slate-800 p-2 rounded border border-slate-200 dark:border-slate-700">{{ modal.val }}</p>
                </div>
                <div class="px-6 py-2 space-y-4">
                    <div v-if="modal.type === 'RESTORE'">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Action / Destination</label>
                        <select v-model="modal.targetKey" class="w-full bg-slate-100 dark:bg-slate-950 border border-slate-300 dark:border-slate-700 rounded-lg p-2 text-sm outline-none focus:border-indigo-500 text-slate-800 dark:text-slate-200">
                            <option value="">üö´ Just Unblock (Delete from System)</option>
                            <option value="GOOD_IPS">üåç Restore to Allowed IPs</option>
                            <option value="GOOD_REFERRERS">üîó Restore to Referrers</option>
                            <option value="SEARCH_BOTS">ü§ñ Restore to Search Bots</option>
                            <option value="AI_BOTS">üß† Restore to AI Agents</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">
                            {{ modal.type === 'BLOCK' ? 'Reason for Blocking (Required)' : 'Reason / Audit Note' }}
                        </label>
                        <textarea v-model="modal.reason" class="w-full bg-slate-100 dark:bg-slate-950 border border-slate-300 dark:border-slate-700 rounded-lg p-3 text-sm focus:border-indigo-500 outline-none text-slate-800 dark:text-slate-200 placeholder-slate-400" rows="3" :placeholder="modal.type === 'BLOCK' ? 'e.g. High traffic attack, Scraping...' : 'e.g. False positive, Verified safe...'"></textarea>
                    </div>
                </div>
                <div class="bg-slate-50 dark:bg-slate-950/50 p-4 flex gap-3 justify-end border-t border-slate-200 dark:border-slate-800 mt-2">
                    <button @click="closeModal" class="px-4 py-2 text-xs font-bold text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-colors">Cancel</button>
                    <button @click="confirmAction" class="px-4 py-2 text-white text-xs font-bold rounded-lg transition-colors shadow-lg" :class="modal.type === 'BLOCK' ? 'bg-red-600 hover:bg-red-700 shadow-red-500/20' : 'bg-emerald-600 hover:bg-emerald-700 shadow-emerald-500/20'">Confirm Action</button>
                </div>
            </div>
        </div>
    </transition>

    <transition name="toast">
        <div v-if="toast.show" class="fixed bottom-6 right-6 z-50 px-6 py-4 rounded-xl shadow-2xl flex items-center gap-4 border border-slate-200 dark:border-white/10 backdrop-blur-md" :class="toast.isError ? 'bg-red-100 text-red-800 dark:bg-red-900/90 dark:text-red-100' : 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900/90 dark:text-emerald-100'">
            <div class="text-2xl">{{ toast.isError ? '‚ùå' : '‚úÖ' }}</div>
            <div>
                <h4 class="font-bold text-sm">{{ toast.title }}</h4>
                <p class="text-xs opacity-90">{{ toast.message }}</p>
            </div>
        </div>
    </transition>

    <div v-if="!token || isInitializing" class="flex-grow flex items-center justify-center relative">
        <div class="absolute inset-0 overflow-hidden pointer-events-none">
            <div class="absolute top-0 left-1/4 w-96 h-96 bg-indigo-500/20 rounded-full blur-3xl opacity-30"></div>
            <div class="absolute bottom-0 right-1/4 w-96 h-96 bg-purple-500/20 rounded-full blur-3xl opacity-30"></div>
        </div>
        <div v-if="isInitializing" class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 z-10"></div>
        <div v-else class="bg-white/80 dark:bg-white/10 backdrop-blur-md p-10 rounded-3xl shadow-2xl border border-white/20 dark:border-white/10 max-w-sm w-full text-center z-10">
            <div class="w-14 h-14 mx-auto mb-6 rounded-full bg-indigo-600 flex items-center justify-center text-2xl shadow-lg text-white">üõ°Ô∏è</div>
            <h2 class="text-lg font-bold mb-6 text-slate-800 dark:text-white tracking-widest uppercase text-xs">Security Manager v6.6</h2>
            <input type="password" v-model="tokenInput" class="w-full p-3.5 rounded-xl bg-slate-50 dark:bg-slate-900/50 border border-slate-300 dark:border-slate-700 text-center font-mono text-sm mb-6 outline-none focus:border-indigo-500 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-slate-500" placeholder="GitHub Token">
            <button @click="setToken" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl transition-all active:scale-95 text-xs uppercase">Connect</button>
        </div>
    </div>

    <div v-else class="flex h-full">
        <aside class="w-64 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex flex-col shrink-0 transition-all duration-300" :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full absolute md:relative md:translate-x-0 z-50 h-full'">
            <div class="p-6 flex items-center gap-3 border-b border-slate-200 dark:border-slate-800">
                <div class="w-8 h-8 rounded bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white text-sm">üõ°Ô∏è</div>
                <div><h1 class="font-bold text-slate-800 dark:text-white text-sm">Security Hub</h1><p class="text-[10px] text-slate-400 font-bold">System v6.6</p></div>
            </div>
            <nav class="flex-1 overflow-y-auto py-4 px-3 space-y-6">
                <div>
                    <h3 class="px-3 text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">Whitelist</h3>
                    <div class="space-y-1">
                        <button @click="currentView = 'whitelist-update'" :class="currentView === 'whitelist-update' ? 'bg-indigo-50 dark:bg-indigo-600/10 text-indigo-600 dark:text-indigo-400' : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800/50'" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-xs font-medium transition-colors"><span>üìù</span> Update List</button>
                        <button @click="currentView = 'whitelist-readme'" :class="currentView === 'whitelist-readme' ? 'bg-indigo-50 dark:bg-indigo-600/10 text-indigo-600 dark:text-indigo-400' : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800/50'" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-xs font-medium transition-colors"><span>üìñ</span> ReadMe & History</button>
                        <button @click="loadJson('whitelist')" :class="currentView === 'whitelist-json' ? 'bg-indigo-50 dark:bg-indigo-600/10 text-indigo-600 dark:text-indigo-400' : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800/50'" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-xs font-medium transition-colors"><span>üì¶</span> JSON Source</button>
                        <button @click="loadLog('whitelist')" :class="currentView === 'whitelist-log' ? 'bg-indigo-50 dark:bg-indigo-600/10 text-indigo-600 dark:text-indigo-400' : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800/50'" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-xs font-medium transition-colors"><span>üìú</span> Audit Logs</button>
                    </div>
                </div>
                <div><h3 class="px-3 text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">Live Blacklist</h3><div class="space-y-1"><button @click="loadJson('livelist')" :class="currentView === 'livelist-json' ? 'bg-indigo-50 dark:bg-indigo-600/10 text-indigo-600 dark:text-indigo-400' : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800/50'" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-xs font-medium transition-colors"><span>üì¶</span> JSON Source</button><button @click="loadLog('livelist')" :class="currentView === 'livelist-log' ? 'bg-indigo-50 dark:bg-indigo-600/10 text-indigo-600 dark:text-indigo-400' : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800/50'" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-xs font-medium transition-colors"><span>‚ö°</span> Live Logs</button></div></div>
                <div><h3 class="px-3 text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">Global Blacklist</h3><div class="space-y-1"><button @click="loadJson('blacklist')" :class="currentView === 'blacklist-json' ? 'bg-indigo-50 dark:bg-indigo-600/10 text-indigo-600 dark:text-indigo-400' : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800/50'" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-xs font-medium transition-colors"><span>üì¶</span> JSON Source</button><button @click="loadLog('blacklist')" :class="currentView === 'blacklist-log' ? 'bg-indigo-50 dark:bg-indigo-600/10 text-indigo-600 dark:text-indigo-400' : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800/50'" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-xs font-medium transition-colors"><span>‚õî</span> Block Logs</button></div></div>
            </nav>
            <div class="p-4 border-t border-slate-200 dark:border-slate-800">
                <button @click="logout" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-slate-100 hover:bg-red-50 hover:text-red-500 dark:bg-slate-800 dark:hover:bg-red-900/20 dark:hover:text-red-400 text-slate-500 dark:text-slate-400 text-xs font-bold rounded-lg transition-colors">Disconnect</button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 bg-slate-50 dark:bg-[#0B1120] relative transition-colors duration-300">
            <header class="h-14 border-b border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-slate-900/50 backdrop-blur flex items-center justify-between px-6 shrink-0 transition-colors duration-300">
                <button @click="sidebarOpen = !sidebarOpen" class="md:hidden text-slate-400">‚ò∞</button>
                <div class="text-sm font-bold font-mono text-indigo-500 dark:text-indigo-400">{{ targetRepo }}</div>
                <div class="flex items-center gap-4">
                    <div class="text-xs font-bold font-mono text-slate-500" :class="{'text-red-400 animate-pulse': timeLeft < 60}">‚è±Ô∏è {{ formattedTime }}</div>
                    <button @click="toggleTheme" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors text-slate-500 dark:text-slate-400"><span v-if="isDark" class="text-lg">‚òÄÔ∏è</span><span v-else class="text-lg">üåô</span></button>
                    
                    <button v-if="currentView === 'whitelist-update'" @click="saveChanges" :disabled="loading || isPolling" class="flex items-center gap-2 px-4 py-1.5 rounded-lg text-xs font-bold text-white shadow-lg transition-all active:scale-95 disabled:opacity-50" :class="hasUnsavedChanges ? 'bg-amber-500 hover:bg-amber-600' : (isPolling ? 'bg-indigo-400 cursor-wait' : 'bg-indigo-600 hover:bg-indigo-700')">
                        <span v-if="loading" class="animate-spin">‚è≥</span>
                        <span v-else-if="isPolling" class="animate-pulse">üîÑ Processing Remote...</span>
                        <span v-else>{{ hasUnsavedChanges ? '‚ö†Ô∏è Unsaved Changes' : 'üíæ Commit Updates' }}</span>
                    </button>
                </div>
            </header>

            <div v-if="currentView === 'whitelist-update'" class="flex-1 overflow-y-auto p-6">
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 pb-20">
                    <div v-for="(list, key) in editableLists" :key="key" class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden shadow-sm flex flex-col h-[600px] transition-colors duration-300">
                        <div class="px-4 py-3 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 flex justify-between items-center">
                            <h3 class="font-bold text-sm text-slate-700 dark:text-slate-200 flex items-center gap-2">
                                {{ list.title }}
                                <span v-if="key === 'BLOCKED_THREATS'" class="text-[10px] bg-red-100 dark:bg-red-500/20 text-red-600 dark:text-red-400 px-1.5 py-0.5 rounded uppercase tracking-wider font-bold">Threats</span>
                            </h3>
                            <span class="bg-slate-200 dark:bg-slate-700 text-xs px-2 py-0.5 rounded font-mono text-slate-600 dark:text-slate-300">{{ list.items.length }}</span>
                        </div>
                        <div class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-2">
                            <div v-for="(item, index) in list.items" :key="index" class="p-3 bg-slate-50 dark:bg-slate-900/30 rounded-lg border border-transparent hover:border-indigo-500/30 group transition-all">
                                <div class="flex flex-col gap-1 mb-1">
                                    <div class="flex justify-between items-start">
                                        <div class="flex flex-col">
                                            <span class="font-mono text-sm text-indigo-600 dark:text-indigo-400 font-bold break-all">{{ item.val }}</span>
                                            <span v-if="getOrigin(item.note)" class="text-[10px] bg-slate-200 dark:bg-slate-800 text-slate-700 dark:text-slate-300 px-1.5 py-0.5 rounded w-fit mt-1 font-bold">
                                                From: {{ getOrigin(item.note) }}
                                            </span>
                                        </div>
                                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button v-if="key !== 'BLOCKED_THREATS'" @click="openModal('BLOCK', key, index, item)" class="text-slate-400 hover:text-red-500 px-1" title="Block">‚õî</button>
                                            <button v-if="key === 'BLOCKED_THREATS'" @click="openModal('RESTORE', key, index, item)" class="text-slate-400 hover:text-emerald-500 px-1" title="Restore">‚ôªÔ∏è</button>
                                            <button @click="deleteItem(key, index, item)" class="text-slate-400 hover:text-red-500 px-1" title="Delete">‚úï</button>
                                        </div>
                                    </div>
                                </div>
                                <textarea v-model="item.note" @input="markDirty" class="w-full bg-transparent text-xs text-slate-600 dark:text-slate-300 focus:text-slate-900 dark:focus:text-white border-none p-0 outline-none resize-none placeholder-slate-400" rows="1" placeholder="Add note..."></textarea>
                            </div>
                        </div>
                        <div class="p-3 bg-slate-100 dark:bg-slate-900 border-t border-slate-200 dark:border-slate-700">
                            <div class="flex gap-2 mb-2"><input v-model="inputs[key].val" @keyup.enter="addItem(key)" class="flex-1 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded px-3 py-2 text-xs font-mono outline-none focus:border-indigo-500 text-slate-800 dark:text-white" :placeholder="list.placeholder"></div>
                            <div class="flex gap-2"><input v-model="inputs[key].note" @keyup.enter="addItem(key)" class="flex-1 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded px-3 py-2 text-xs outline-none focus:border-indigo-500 text-slate-800 dark:text-white" placeholder="Optional Note..."><button @click="addItem(key)" class="bg-indigo-600 hover:bg-indigo-700 text-white rounded px-3 py-2 text-xs font-bold">Add</button></div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentView === 'whitelist-readme'" class="flex-1 overflow-hidden p-6 relative">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
                    <div class="flex flex-col bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden shadow-sm h-full">
                        <div class="p-4 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50">
                            <h2 class="text-sm font-bold text-slate-700 dark:text-white">üõ°Ô∏è Security Whitelist Documentation</h2>
                            <p class="text-[10px] text-slate-500 mt-1">Last Updated: {{ new Date().toUTCString() }}</p>
                        </div>
                        <div class="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-6">
                            <div v-for="(list, key) in editableLists" :key="key">
                                <h3 class="font-bold text-sm text-slate-800 dark:text-slate-200 mb-2 border-b border-slate-200 dark:border-slate-700 pb-1">{{ list.title }}</h3>
                                <div v-if="list.items.length === 0" class="text-xs text-slate-400 italic">No records.</div>
                                <ul v-else class="space-y-1">
                                    <li v-for="item in list.items" class="text-xs text-slate-600 dark:text-slate-400 font-mono flex items-center gap-2">
                                        <span class="text-slate-400">‚Ä¢</span>
                                        <span class="bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded">{{ item.val }}</span>
                                        <span v-if="item.note" class="text-[11px] text-slate-400 dark:text-slate-300 italic">üìù {{ item.note }}</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden shadow-sm h-full">
                        <div class="p-4 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50">
                            <h2 class="text-sm font-bold text-slate-700 dark:text-white mb-2">üìú Threat History (Permanent Log)</h2>
                            <div class="flex gap-2">
                                <div class="relative flex-1">
                                    <span class="absolute left-3 top-2.5 text-slate-400 text-xs">üîç</span>
                                    <input v-model="historySearchQuery" placeholder="Search History..." class="w-full bg-white dark:bg-slate-950 border border-slate-300 dark:border-slate-700 rounded-lg pl-9 pr-3 py-2 text-xs focus:border-indigo-500 outline-none text-slate-800 dark:text-white placeholder-slate-400">
                                </div>
                                <button class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-xs font-bold transition-colors">Search</button>
                            </div>
                        </div>
                        <div class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-1">
                            <div v-if="filteredHistory.length === 0" class="text-center text-slate-400 text-xs italic mt-10">No history records found.</div>
                            <div v-for="(h, i) in filteredHistory" :key="i" class="p-2 rounded border border-slate-100 dark:border-slate-800/50 bg-slate-50/50 dark:bg-slate-950/30 hover:bg-slate-100 dark:hover:bg-slate-900 transition-colors flex flex-col gap-0.5">
                                <div class="flex justify-between items-baseline gap-2">
                                    <div class="flex items-center gap-2 min-w-0">
                                        <span class="text-[9px] font-bold px-1.5 py-0.5 rounded uppercase shrink-0" :class="(h.action.includes('ADDED') || h.action.includes('BLOCKED')) ? 'bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400' : 'bg-emerald-100 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-400'">{{ h.action }}</span>
                                        <code class="text-xs font-mono text-slate-800 dark:text-slate-200 font-bold truncate">{{ h.val }}</code>
                                    </div>
                                    <span class="text-[9px] font-mono text-slate-400 dark:text-slate-300 shrink-0">{{ h.date }}</span>
                                </div>
                                <div v-if="h.note" class="text-[10px] text-slate-500 dark:text-slate-300 italic pl-1 truncate">‚Ü≥ {{ h.note }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div v-if="currentView.includes('-json')" class="flex-1 overflow-hidden flex flex-col bg-slate-50 dark:bg-slate-950 relative transition-colors duration-300">
                <div v-if="loadingLog" class="absolute inset-0 flex items-center justify-center bg-slate-50 dark:bg-slate-950 z-20"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"></div></div>
                <div class="p-3 border-b border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 flex justify-between items-center sticky top-0 z-10" v-if="activeLogContent && !activeLogContent.startsWith('Error')">
                    <div class="text-xs font-mono text-slate-500 font-bold">JSON Explorer</div>
                    <div class="flex gap-2 items-center">
                        <button @click="showRawJson = !showRawJson" class="px-2 py-1 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 rounded text-[10px] hover:bg-slate-200 dark:hover:bg-slate-700">{{ showRawJson ? 'Show Tree' : 'Show Raw' }}</button>
                        <button @click="expandAll" class="px-2 py-1 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 rounded text-[10px] hover:bg-slate-200 dark:hover:bg-slate-700" v-if="!showRawJson">Expand All</button>
                        <button @click="collapseAll" class="px-2 py-1 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 rounded text-[10px] hover:bg-slate-200 dark:hover:bg-slate-700" v-if="!showRawJson">Collapse All</button>
                        <div class="relative" v-if="!showRawJson"><input v-model="jsonSearchQuery" placeholder="Filter..." class="bg-slate-100 dark:bg-slate-950 border border-slate-300 dark:border-slate-700 rounded px-2 py-1 text-xs outline-none focus:border-indigo-500 text-slate-800 dark:text-white w-32"></div>
                    </div>
                </div>
                <div v-if="!activeLogContent || activeLogContent.trim() === ''" class="flex-1 flex flex-col items-center justify-center text-slate-500"><div class="text-4xl mb-4 grayscale opacity-50">üìÇ</div><h3 class="font-bold text-sm mb-1">File Empty or Missing</h3></div>
                <div v-else class="flex-1 overflow-y-auto p-6 custom-scrollbar bg-[#0d1117]" ref="jsonContainer"><pre v-if="showRawJson" class="font-mono text-xs text-emerald-400 whitespace-pre-wrap">{{ activeLogContent }}</pre><div v-else class="json-tree" v-html="renderJsonTree(filteredJsonObj)"></div></div>
            </div>

            <div v-if="currentView.includes('-log')" class="flex-1 overflow-y-auto p-4 custom-scrollbar bg-white dark:bg-slate-950"><div v-if="loadingLog" class="flex justify-center mt-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"></div></div><pre v-else class="font-mono text-xs whitespace-pre-wrap" v-html="formattedLogContent"></pre></div>
        </main>
    </div>
</div>

<script type="module">
    import { Octokit } from "https://esm.sh/@octokit/core";
    const { createApp } = Vue;

    const TARGET_OWNER = 'malaareda'; 
    const TARGET_REPO  = 'security-list';         
    const FILE_TEMP    = 'security-list-backup/security-whitelist-backup/security-whitelist-temp.json';
    const FILE_README  = 'security-list-backup/security-whitelist-backup/README.md';
    const JSON_FILES = { 'whitelist': 'security-list-backup/security-whitelist-backup/security-whitelist-R.00.json', 'blacklist': 'security-list-backup/security-blacklist-backup/security-blacklist-R.00.json', 'livelist':  'security-list-backup/security-live-blacklist-backup/security-live-blacklist-R.00.json' };
    const LOGS = { 'whitelist': 'security-list-backup/security-whitelist-backup/whitelist-security-audit.log', 'blacklist': 'security-list-backup/security-blacklist-backup/blacklist-security-audit.log', 'livelist':  'security-list-backup/security-live-blacklist-backup/live-blacklist-security-audit.log' };
    const STATUS_CONFIG = { SUCCESS:{label:'SUCCESS',hex:'#16a34a'}, INFO:{label:'INFO',hex:'#2563eb'}, WARN:{label:'WARNING',hex:'#d97706'}, ERROR:{label:'ERROR',hex:'#dc2626'}, PROCESS:{label:'PROCESS',hex:'#0891b2'}, START:{label:'START',hex:'#9333ea'}, CLEANUP:{label:'CLEANUP',hex:'#4b5563'} };
    const INACTIVITY_MINUTES = 10; 

    createApp({
        data() {
            return {
                isInitializing: true, token: localStorage.getItem('gh_token') || '', tokenInput: '', loading: false, loadingLog: false, sidebarOpen: false, targetRepo: `${TARGET_OWNER}/${TARGET_REPO}`, isDark: true, currentView: 'whitelist-update', targetTime: 0, timeLeft: INACTIVITY_MINUTES * 60, countdownInterval: null, hasUnsavedChanges: false, activeLogContent: '',
                toast: { show: false, title: '', message: '', isError: false },
                modal: { show: false, type: '', sourceKey: '', index: null, val: '', reason: '', targetKey: '' },
                sessionHistory: [], existingReadmeContent: '', historySearchQuery: '', jsonSearchQuery: '', parsedActiveJson: null, showRawJson: false,
                // [NEW] Polling State
                isPolling: false, pollInterval: null, currentGeneratedAt: null,
                editableLists: { GOOD_IPS:{title:'üåç Allowed IPs',placeholder:'IP Address...',items:[]}, BLOCKED_THREATS:{title:'‚õî Blocked Threats',placeholder:'IP / UA / Domain...',items:[]}, GOOD_REFERRERS:{title:'üîó Referrers',placeholder:'Domain...',items:[]}, SEARCH_BOTS:{title:'ü§ñ Search Bots',placeholder:'User-Agent...',items:[]}, AI_BOTS:{title:'üß† AI Agents',placeholder:'User-Agent...',items:[]} },
                inputs: { GOOD_IPS:{val:'',note:''}, BLOCKED_THREATS:{val:'',note:''}, GOOD_REFERRERS:{val:'',note:''}, SEARCH_BOTS:{val:'',note:''}, AI_BOTS:{val:'',note:''} }
            }
        },
        computed: {
            formattedTime() { const m=Math.floor(Math.max(0,this.timeLeft)/60).toString().padStart(2,'0'); const s=(Math.max(0,this.timeLeft)%60).toString().padStart(2,'0'); return `${m}:${s}`; },
            renderedReadme() { return marked.parse(this.generateReadmeContent(true)); },
            totalItems() { let c=0; for(const k in this.editableLists) c+=this.editableLists[k].items.length; return c; },
            parsedHistory() { const h=[]; this.sessionHistory.forEach(i=>h.push(i)); if(this.existingReadmeContent.includes('## üìú')){ const lines=this.existingReadmeContent.split('## üìú')[1].split('\n'); lines.forEach(l=>{const m=l.match(/- (.*?) \[(.*?)\] \*\*(.*?)\*\*: \`(.*?)\` \| Reason: \*(.*?)\*/); if(m)h.push({date:m[2],action:m[3],val:m[4],note:m[5]});}); } return h; },
            filteredHistory() { if(!this.historySearchQuery)return this.parsedHistory; const q=this.historySearchQuery.toLowerCase(); return this.parsedHistory.filter(i=>i.val.toLowerCase().includes(q)||i.note.toLowerCase().includes(q)||i.action.toLowerCase().includes(q)); },
            filteredJsonObj() { if(!this.parsedActiveJson)return null; if(!this.jsonSearchQuery)return this.parsedActiveJson; return this.filterObject(this.parsedActiveJson, this.jsonSearchQuery.toLowerCase()); },
            formattedLogContent() { if(!this.activeLogContent)return ''; return this.activeLogContent.split('\n').map(l=>{ if(l.startsWith('=')||l.startsWith('-')||l.includes('[SESSION')) return `<span class="text-slate-900 dark:text-yellow-400 font-bold">${l}</span>`; for(const k in STATUS_CONFIG)if(l.includes(STATUS_CONFIG[k].label))return `<span style="color:${STATUS_CONFIG[k].hex};font-weight:600">${l}</span>`; return `<span class="text-slate-600 dark:text-slate-400">${l}</span>`; }).join('\n'); }
        },
        mounted() { this.initTheme(); if(this.token){this.loadWhitelistData();this.startCountdown();}else{this.isInitializing=false;} ['mousemove','keydown','click'].forEach(e=>window.addEventListener(e,this.resetActivity)); },
        methods: {
            initTheme() { const t=localStorage.getItem('theme'); this.isDark=t?t==='dark':true; this.applyTheme(); },
            toggleTheme() { this.isDark=!this.isDark; localStorage.setItem('theme',this.isDark?'dark':'light'); this.applyTheme(); },
            applyTheme() { if(this.isDark)document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark'); },
            showToast(t,m,e=false) { if(this.isInitializing)return; this.toast={show:true,title:t,message:m,isError:e}; setTimeout(()=>{this.toast.show=false},4000); },
            setToken() { if(!this.tokenInput.trim())return; this.token=this.tokenInput; localStorage.setItem('gh_token',this.token); this.loadWhitelistData(); this.startCountdown(); },
            logout() { this.token=''; localStorage.removeItem('gh_token'); clearInterval(this.countdownInterval); this.isInitializing=false; },
            startCountdown() { this.resetActivity(); if(this.countdownInterval)clearInterval(this.countdownInterval); this.countdownInterval=setInterval(()=>{ const n=Date.now(); this.timeLeft=Math.ceil((this.targetTime-n)/1000); if(this.timeLeft<=0)this.logout(); },1000); },
            resetActivity() { if(!this.token)return; this.targetTime=Date.now()+(INACTIVITY_MINUTES*60*1000); },
            markDirty() { this.hasUnsavedChanges=true; this.resetActivity(); },

            async loadWhitelistData() {
                this.loading=true; const octokit=new Octokit({auth:this.token});
                try {
                    // Load R.00 JSON
                    const r1=await octokit.request(`GET /repos/${TARGET_OWNER}/${TARGET_REPO}/contents/${JSON_FILES['whitelist']}`);
                    const json=JSON.parse(decodeURIComponent(escape(atob(r1.data.content))));
                    
                    // [NEW] Capture Generation Time for Polling
                    if(json.meta && json.meta.generatedAt) this.currentGeneratedAt = json.meta.generatedAt;

                    try{const r2=await octokit.request(`GET /repos/${TARGET_OWNER}/${TARGET_REPO}/contents/${FILE_README}`); this.existingReadmeContent=decodeURIComponent(escape(atob(r2.data.content)));}catch(e){this.existingReadmeContent='';}
                    this.mergeData(json,this.existingReadmeContent);
                    this.isInitializing=false; this.hasUnsavedChanges=false;
                } catch(e) { 
                    if(e.status===404) { this.isInitializing=false; this.hasUnsavedChanges=false; } // New Repo
                    else { if(!this.isInitializing)this.showToast('Login Failed',e.message,true); this.logout(); }
                } finally { this.loading=false; }
            },
            mergeData(json, readme) {
                const map={}; readme.split('\n').forEach(l=>{const m=l.match(/- `(.*?)` \| üìù (.*)/); if(m)map[m[1]]=m[2];});
                const pop=(k,arr)=>{ this.editableLists[k].items=(arr||[]).map(v=>({val:v,note:map[v]||''})); };
                pop('GOOD_IPS',json.GOOD_IPS); pop('BLOCKED_THREATS',json.BLOCKED_THREATS||json.BLOCKED_IPS); pop('GOOD_REFERRERS',json.GOOD_REFERRERS); pop('SEARCH_BOTS',json.GOOD_BOTS?.SEARCH_BOTS); pop('AI_BOTS',json.GOOD_BOTS?.AI_BOTS);
            },
            
            // --- SMART POLLING ENGINE ---
            startPolling() {
                this.isPolling = true;
                this.showToast('Processing', 'Updates sent to GitHub. Waiting for automation...');
                
                if (this.pollInterval) clearInterval(this.pollInterval);
                
                // Poll every 3 seconds
                this.pollInterval = setInterval(async () => {
                    const octokit = new Octokit({ auth: this.token });
                    try {
                        // Check R.00.json timestamp (cache-busting with timestamp query)
                        const res = await octokit.request(`GET /repos/${TARGET_OWNER}/${TARGET_REPO}/contents/${JSON_FILES['whitelist']}?t=${Date.now()}`);
                        const content = JSON.parse(decodeURIComponent(escape(atob(res.data.content))));
                        
                        // Compare Timestamps
                        const newGenTime = content.meta?.generatedAt;
                        if (newGenTime && newGenTime !== this.currentGeneratedAt) {
                            console.log("New data detected!", newGenTime);
                            clearInterval(this.pollInterval);
                            this.isPolling = false;
                            
                            // Reload Data
                            this.currentGeneratedAt = newGenTime;
                            this.loadWhitelistData(); // Reload UI
                            this.showToast('Sync Complete', 'GitHub automation finished. Data reloaded.', false);
                        }
                    } catch (e) {
                        console.log("Polling check failed, retrying..."); 
                    }
                }, 3000); // 3 seconds
            },

            async saveChanges() {
                this.loading=true; const octokit=new Octokit({auth:this.token});
                try {
                    const pl = { GOOD_IPS:this.editableLists.GOOD_IPS.items.map(i=>i.val), BLOCKED_THREATS:this.editableLists.BLOCKED_THREATS.items.map(i=>i.val), GOOD_REFERRERS:this.editableLists.GOOD_REFERRERS.items.map(i=>i.val), GOOD_BOTS:{ SEARCH_BOTS:this.editableLists.SEARCH_BOTS.items.map(i=>i.val), AI_BOTS:this.editableLists.AI_BOTS.items.map(i=>i.val) } };
                    const md = this.generateReadmeContent(false);
                    let sha1=null; try{const r=await octokit.request(`GET /repos/${TARGET_OWNER}/${TARGET_REPO}/contents/${FILE_TEMP}`); sha1=r.data.sha;}catch(e){}
                    await octokit.request(`PUT /repos/${TARGET_OWNER}/${TARGET_REPO}/contents/${FILE_TEMP}`, { message:'üõ°Ô∏è Update Whitelist (WebUI)', content:btoa(unescape(encodeURIComponent(JSON.stringify(pl,null,2)))), sha:sha1 });
                    
                    let sha2=null; try{const r=await octokit.request(`GET /repos/${TARGET_OWNER}/${TARGET_REPO}/contents/${FILE_README}`); sha2=r.data.sha;}catch(e){}
                    await octokit.request(`PUT /repos/${TARGET_OWNER}/${TARGET_REPO}/contents/${FILE_README}`, { message:'üìù Update Docs', content:btoa(unescape(encodeURIComponent(md))), sha:sha2 });
                    
                    this.hasUnsavedChanges=false; this.sessionHistory=[]; this.existingReadmeContent=md; this.resetActivity();
                    
                    // [UPDATED] Don't show "Success" yet. Start Polling instead.
                    this.startPolling(); 

                } catch(e) { console.error(e); this.showToast('Error',e.message,true); } finally { this.loading=false; }
            },

            // Other unchanged methods...
            filterObject(obj, query) { if (!query) return obj; if (typeof obj!=='object'||obj===null) return String(obj).toLowerCase().includes(query)?obj:undefined; if(Array.isArray(obj)){const f=obj.map(i=>this.filterObject(i,query)).filter(i=>i!==undefined);return f.length?f:undefined;} const r={};let h=false;Object.keys(obj).forEach(k=>{if(k.toLowerCase().includes(query)){r[k]=obj[k];h=true;}else{const v=this.filterObject(obj[k],query);if(v!==undefined){r[k]=v;h=true;}}}); return h?r:undefined; },
            renderJsonTree(data) { if(data===undefined)return '<span class="j-null">No matches.</span>'; if(data===null)return '<span class="j-null">null</span>'; if(typeof data==='string')return `<span class="j-str">"${data}"</span>`; if(typeof data==='number')return `<span class="j-num">${data}</span>`; if(typeof data==='boolean')return `<span class="j-bool">${data}</span>`; const arr=Array.isArray(data); const k=Object.keys(data); if(!k.length)return arr?'<span class="j-meta">[]</span>':'<span class="j-meta">{}</span>'; let h=`<details open><summary><span class="json-arrow">‚ñ∂</span> <span class="j-meta">${arr?`Array(${k.length})`:`Object{${k.length}}`}</span></summary>`; k.forEach(key=>{h+=`<div>`;if(!arr)h+=`<span class="j-key">"${key}"</span>: `;h+=this.renderJsonTree(data[key]);h+=`<span class="j-meta">,</span></div>`;}); h+=`</details>`; return h; },
            expandAll() { this.$refs.jsonContainer.querySelectorAll('details').forEach(d=>d.open=true); }, collapseAll() { this.$refs.jsonContainer.querySelectorAll('details').forEach(d=>d.open=false); }, copyJson() { if(this.parsedActiveJson) { navigator.clipboard.writeText(JSON.stringify(this.parsedActiveJson,null,4)); this.showToast('Copied','JSON copied.'); } }, triggerJsonSearch() {}, getOrigin(note) { if(!note)return null; const m=note.match(/\[Origin: (.*?)\]/); if(m){const k=m[1];const l=this.editableLists[k];return l?l.title.replace(/^[^\s]+\s/,''):k;} return null; }, getLogTimestamp() { const n=new Date(); return `${n.toLocaleDateString('en-CA')} ${n.toLocaleTimeString('en-US',{hour12:true})}`; },
            addItem(key) { const v=this.inputs[key].val.trim(); const n=this.inputs[key].note.trim(); if(!v)return; if(key==='BLOCKED_THREATS'&&!n){this.showToast('Error','Note required.',true);return;} this.editableLists[key].items.unshift({val:v,note:n}); this.inputs[key].val='';this.inputs[key].note=''; if(key==='BLOCKED_THREATS')this.sessionHistory.push({action:'ADDED',val:v,note:n,date:this.getLogTimestamp()}); this.markDirty(); },
            deleteItem(key,index,item) { if(key==='BLOCKED_THREATS'){this.openModal('RESTORE',key,index,item);return;} this.editableLists[key].items.splice(index,1); this.markDirty(); },
            openModal(t,k,i,v) { let tk=''; if(t==='RESTORE'){const m=v.note?v.note.match(/\[Origin: (.*?)\]/):null;if(m&&this.editableLists[m[1]])tk=m[1];} this.modal={show:true,type:t,sourceKey:k,index:i,val:v.val,reason:'',targetKey:tk}; },
            closeModal() { this.modal.show=false; },
            confirmAction() { if(!this.modal.reason.trim()){this.showToast('Error','Reason required.',true);return;} this.editableLists[this.modal.sourceKey].items.splice(this.modal.index,1); if(this.modal.type==='BLOCK'){const n=`[Origin: ${this.modal.sourceKey}] ${this.modal.reason}`;this.editableLists.BLOCKED_THREATS.items.unshift({val:this.modal.val,note:n});this.sessionHistory.push({action:'BLOCKED',val:this.modal.val,note:`Source: ${this.modal.sourceKey} | ${this.modal.reason}`,date:this.getLogTimestamp()});}else{if(this.modal.targetKey){this.editableLists[this.modal.targetKey].items.unshift({val:this.modal.val,note:this.modal.reason});this.sessionHistory.push({action:'RESTORED',val:this.modal.val,note:`Restored to ${this.modal.targetKey} | ${this.modal.reason}`,date:this.getLogTimestamp()});}else{this.sessionHistory.push({action:'UNBLOCKED',val:this.modal.val,note:this.modal.reason,date:this.getLogTimestamp()});}} this.markDirty(); this.closeModal(); },
            generateReadmeContent(p=false) { let md=`# üõ°Ô∏è Security Whitelist Documentation\n\n**Last Updated:** ${new Date().toUTCString()}\n\n> Auto-generated by Security Manager WebUI.\n\n`; const s=[{key:'GOOD_IPS',t:'üåç Allowed IPs'},{key:'BLOCKED_THREATS',t:'‚õî Blocked Threats'},{key:'GOOD_REFERRERS',t:'üîó Referrers'},{key:'SEARCH_BOTS',t:'ü§ñ Search Bots'},{key:'AI_BOTS',t:'üß† AI Agents'}]; s.forEach(x=>{md+=`## ${x.t}\n`;const i=this.editableLists[x.key].items;if(!i.length)md+='*No records.*\n\n';else{i.forEach(j=>{md+=`- \`${j.val}\`${j.note?` | üìù ${j.note}`:''}\n`;});md+='\n';}}); const h=`## üìú Threat History (Permanent Log)`; let ht=''; if(this.existingReadmeContent.includes(h))ht=this.existingReadmeContent.split(h)[1].trim(); if(this.sessionHistory.length){const nl=this.sessionHistory.map(x=>{let c='‚ö™';if(x.action.includes('ADDED')||x.action.includes('BLOCKED'))c='üî¥';else c='üü¢'; return `- ${c} [${x.date}] **${x.action}**: \`${x.val}\` | Reason: *${x.note}*`;}).join('\n');ht=ht?ht+'\n'+nl:nl;} md+=`\n${h}\n${ht||'*No history yet.*'}\n`; return md; },
            async loadLog(t) { this.currentView=t+'-log'; this.activeLogContent=''; this.loadingLog=true; const octokit=new Octokit({auth:this.token}); try{const r=await octokit.request(`GET /repos/${TARGET_OWNER}/${TARGET_REPO}/contents/${LOGS[t]}`); this.activeLogContent=decodeURIComponent(escape(atob(r.data.content)));}catch(e){if(e.status!==404)this.activeLogContent=`Error: ${e.message}`;}finally{this.loadingLog=false;} },
            async loadJson(t) { this.currentView=t+'-json'; this.activeLogContent=''; this.loadingLog=true; const octokit=new Octokit({auth:this.token}); try{const r=await octokit.request(`GET /repos/${TARGET_OWNER}/${TARGET_REPO}/contents/${JSON_FILES[t]}`); const c=decodeURIComponent(escape(atob(r.data.content))); this.activeLogContent=c; this.parsedActiveJson=JSON.parse(c);}catch(e){if(e.status!==404)this.activeLogContent=`Error: ${e.message}`;}finally{this.loadingLog=false;} }
        }
    }).mount('#app');
</script>
</body>
</html>
