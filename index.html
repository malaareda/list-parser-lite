<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Manager v5.6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
        import { Octokit } from "https://esm.sh/@octokit/core";
        window.Octokit = Octokit;
    </script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { slate: { 850: '#15202e', 900: '#0f172a' }, darkbg: '#0B1120' },
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #94a3b8; border-radius: 20px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #475569; }
        
        [v-cloak] { display: none; }
        
        /* Markdown Styles */
        .markdown-body h2 { border-bottom: 1px solid #334155; padding-bottom: 0.5rem; margin-top: 1.5rem; margin-bottom: 1rem; font-size: 1.25rem; font-weight: 600; color: #e2e8f0; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5rem; color: #cbd5e1; }
        .markdown-body li { margin-bottom: 0.25rem; }
        .markdown-body code { background: #1e293b; padding: 0.2rem 0.4rem; rounded: 0.25rem; font-size: 0.875em; color: #cbd5e1; }

        /* Transitions */
        .toast-enter-active, .toast-leave-active { transition: all 0.3s ease; }
        .toast-enter-from, .toast-leave-to { opacity: 0; transform: translateY(20px); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-darkbg text-slate-800 dark:text-slate-200 h-screen overflow-hidden flex flex-col transition-colors duration-300">

<div id="app" class="h-full flex flex-col" v-cloak>

    <transition name="fade">
        <div v-if="modal.show" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
            <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden transform transition-all">
                
                <div class="p-6 pb-2">
                    <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-1 flex items-center gap-2">
                        <span class="text-xl">{{ modal.type === 'BLOCK' ? '‚õî Block Threat' : '‚ôªÔ∏è Unblock / Restore' }}</span>
                    </h3>
                    <p class="text-xs text-slate-500 font-mono break-all bg-slate-100 dark:bg-slate-800 p-2 rounded border border-slate-200 dark:border-slate-700">
                        {{ modal.val }}
                    </p>
                </div>

                <div class="px-6 py-2 space-y-4">
                    
                    <div v-if="modal.type === 'RESTORE'">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Action / Destination</label>
                        <select v-model="modal.targetKey" class="w-full bg-slate-100 dark:bg-slate-950 border border-slate-300 dark:border-slate-700 rounded-lg p-2 text-sm outline-none focus:border-indigo-500 text-slate-800 dark:text-slate-200">
                            <option value="">üö´ Just Unblock (Delete)</option>
                            <option value="GOOD_IPS">üåç Restore to Allowed IPs</option>
                            <option value="GOOD_REFERRERS">üîó Restore to Referrers</option>
                            <option value="SEARCH_BOTS">ü§ñ Restore to Search Bots</option>
                            <option value="AI_BOTS">üß† Restore to AI Agents</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">
                            {{ modal.type === 'BLOCK' ? 'Reason for Blocking (Required)' : 'Reason / New Note' }}
                        </label>
                        <textarea v-model="modal.reason" class="w-full bg-slate-100 dark:bg-slate-950 border border-slate-300 dark:border-slate-700 rounded-lg p-3 text-sm focus:border-indigo-500 outline-none text-slate-800 dark:text-slate-200 placeholder-slate-400" rows="3" :placeholder="modal.type === 'BLOCK' ? 'e.g. High traffic attack, Scraping...' : 'e.g. False positive, Verified safe...'"></textarea>
                    </div>
                </div>

                <div class="bg-slate-50 dark:bg-slate-950/50 p-4 flex gap-3 justify-end border-t border-slate-200 dark:border-slate-800 mt-2">
                    <button @click="closeModal" class="px-4 py-2 text-xs font-bold text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-colors">Cancel</button>
                    <button @click="confirmAction" class="px-4 py-2 text-white text-xs font-bold rounded-lg transition-colors shadow-lg" :class="modal.type === 'BLOCK' ? 'bg-red-600 hover:bg-red-700 shadow-red-500/20' : 'bg-emerald-600 hover:bg-emerald-700 shadow-emerald-500/20'">
                        {{ modal.type === 'BLOCK' ? 'Confirm Block' : 'Confirm Action' }}
                    </button>
                </div>
            </div>
        </div>
    </transition>

    <transition name="toast">
        <div v-if="toast.show" class="fixed bottom-6 right-6 z-50 px-6 py-4 rounded-xl shadow-2xl flex items-center gap-4 border border-slate-200 dark:border-white/10 backdrop-blur-md" :class="toast.isError ? 'bg-red-100 text-red-800 dark:bg-red-900/90 dark:text-red-100' : 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900/90 dark:text-emerald-100'">
            <div class="text-2xl">{{ toast.isError ? '‚ùå' : '‚úÖ' }}</div>
            <div>
                <h4 class="font-bold text-sm">{{ toast.title }}</h4>
                <p class="text-xs opacity-90">{{ toast.message }}</p>
            </div>
        </div>
    </transition>

    <div v-if="!token || isInitializing" class="flex-grow flex items-center justify-center relative">
        <div class="absolute inset-0 overflow-hidden pointer-events-none">
            <div class="absolute top-0 left-1/4 w-96 h-96 bg-indigo-500/20 rounded-full blur-3xl opacity-30"></div>
            <div class="absolute bottom-0 right-1/4 w-96 h-96 bg-purple-500/20 rounded-full blur-3xl opacity-30"></div>
        </div>
        
        <div v-if="isInitializing" class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 z-10"></div>
        
        <div v-else class="bg-white/80 dark:bg-white/10 backdrop-blur-md p-10 rounded-3xl shadow-2xl border border-white/20 dark:border-white/10 max-w-sm w-full text-center z-10">
            <div class="w-14 h-14 mx-auto mb-6 rounded-full bg-indigo-600 flex items-center justify-center text-2xl shadow-lg text-white">üõ°Ô∏è</div>
            <h2 class="text-lg font-bold mb-6 text-slate-800 dark:text-white tracking-widest uppercase text-xs">Security Manager v5.6</h2>
            <input type="password" v-model="tokenInput" class="w-full p-3.5 rounded-xl bg-slate-50 dark:bg-slate-900/50 border border-slate-300 dark:border-slate-700 text-center font-mono text-sm mb-6 outline-none focus:border-indigo-500 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-slate-500" placeholder="GitHub Token">
            <button @click="setToken" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl transition-all active:scale-95 text-xs uppercase">Connect</button>
        </div>
    </div>

    <div v-else class="flex h-full">
        
        <aside class="w-64 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex flex-col shrink-0 transition-all duration-300" :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full absolute md:relative md:translate-x-0 z-50 h-full'">
            <div class="p-6 flex items-center gap-3 border-b border-slate-200 dark:border-slate-800">
                <div class="w-8 h-8 rounded bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white text-sm">üõ°Ô∏è</div>
                <div><h1 class="font-bold text-slate-800 dark:text-slate-200 text-sm">Security Hub</h1><p class="text-[10px] text-slate-500">System v5.6</p></div>
            </div>
            <nav class="flex-1 overflow-y-auto py-4 px-3 space-y-6">
                <div>
                    <h3 class="px-3 text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">Whitelist</h3>
                    <div class="space-y-1">
                        <button @click="currentView = 'whitelist-update'" :class="currentView === 'whitelist-update' ? 'bg-indigo-50 dark:bg-indigo-600/10 text-indigo-600 dark:text-indigo-400' : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800/50'" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-xs font-medium transition-colors"><span>üìù</span> Update List</button>
                        <button @click="currentView = 'whitelist-readme'" :class="currentView === 'whitelist-readme' ? 'bg-indigo-50 dark:bg-indigo-600/10 text-indigo-600 dark:text-indigo-400' : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800/50'" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-xs font-medium transition-colors"><span>üìñ</span> ReadMe File</button>
                        <button @click="loadJson('whitelist')" :class="currentView === 'whitelist-json' ? 'bg-indigo-50 dark:bg-indigo-600/10 text-indigo-600 dark:text-indigo-400' : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800/50'" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-xs font-medium transition-colors"><span>üì¶</span> JSON Source</button>
                        <button @click="loadLog('whitelist')" :class="currentView === 'whitelist-log' ? 'bg-indigo-50 dark:bg-indigo-600/10 text-indigo-600 dark:text-indigo-400' : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800/50'" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-xs font-medium transition-colors"><span>üìú</span> Audit Logs</button>
                    </div>
                </div>
                <div>
                    <h3 class="px-3 text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">Live Blacklist</h3>
                    <div class="space-y-1">
                        <button @click="loadJson('livelist')" :class="currentView === 'livelist-json' ? 'bg-indigo-50 dark:bg-indigo-600/10 text-indigo-600 dark:text-indigo-400' : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800/50'" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-xs font-medium transition-colors"><span>üì¶</span> JSON Source</button>
                        <button @click="loadLog('livelist')" :class="currentView === 'livelist-log' ? 'bg-indigo-50 dark:bg-indigo-600/10 text-indigo-600 dark:text-indigo-400' : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800/50'" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-xs font-medium transition-colors"><span>‚ö°</span> Live Logs</button>
                    </div>
                </div>
                <div>
                    <h3 class="px-3 text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">Global Blacklist</h3>
                    <div class="space-y-1">
                        <button @click="loadJson('blacklist')" :class="currentView === 'blacklist-json' ? 'bg-indigo-50 dark:bg-indigo-600/10 text-indigo-600 dark:text-indigo-400' : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800/50'" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-xs font-medium transition-colors"><span>üì¶</span> JSON Source</button>
                        <button @click="loadLog('blacklist')" :class="currentView === 'blacklist-log' ? 'bg-indigo-50 dark:bg-indigo-600/10 text-indigo-600 dark:text-indigo-400' : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800/50'" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-xs font-medium transition-colors"><span>‚õî</span> Block Logs</button>
                    </div>
                </div>
            </nav>
            <div class="p-4 border-t border-slate-200 dark:border-slate-800">
                <button @click="logout" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-slate-100 hover:bg-red-50 hover:text-red-500 dark:bg-slate-800 dark:hover:bg-red-900/20 dark:hover:text-red-400 text-slate-500 dark:text-slate-400 text-xs font-bold rounded-lg transition-colors">Disconnect</button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 bg-slate-50 dark:bg-[#0B1120] relative transition-colors duration-300">
            <header class="h-14 border-b border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-slate-900/50 backdrop-blur flex items-center justify-between px-6 shrink-0 transition-colors duration-300">
                <button @click="sidebarOpen = !sidebarOpen" class="md:hidden text-slate-400">‚ò∞</button>
                <div class="text-xs font-mono text-slate-500">{{ targetRepo }}</div>
                <div class="flex items-center gap-4">
                    <div class="text-xs font-bold font-mono text-slate-500" :class="{'text-red-400 animate-pulse': timeLeft < 60}">‚è±Ô∏è {{ formattedTime }}</div>
                    <button @click="toggleTheme" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors text-slate-500 dark:text-slate-400"><span v-if="isDark" class="text-lg">‚òÄÔ∏è</span><span v-else class="text-lg">üåô</span></button>
                    <button v-if="currentView === 'whitelist-update'" @click="saveChanges" :disabled="loading" class="flex items-center gap-2 px-4 py-1.5 rounded-lg text-xs font-bold text-white shadow-lg transition-all active:scale-95 disabled:opacity-50" :class="hasUnsavedChanges ? 'bg-amber-500 hover:bg-amber-600' : 'bg-indigo-600 hover:bg-indigo-700'">
                        <span v-if="loading" class="animate-spin">‚è≥</span>
                        <span v-else>{{ hasUnsavedChanges ? '‚ö†Ô∏è Unsaved Changes' : 'üíæ Commit Updates' }}</span>
                    </button>
                </div>
            </header>

            <div v-if="currentView === 'whitelist-update'" class="flex-1 overflow-y-auto p-6">
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 pb-20">
                    <div v-for="(list, key) in editableLists" :key="key" class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden shadow-sm flex flex-col h-[600px] transition-colors duration-300">
                        
                        <div class="px-4 py-3 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 flex justify-between items-center">
                            <h3 class="font-bold text-sm text-slate-700 dark:text-slate-200 flex items-center gap-2">
                                {{ list.title }}
                                <span v-if="key === 'BLOCKED_THREATS'" class="text-[10px] bg-red-100 dark:bg-red-500/20 text-red-600 dark:text-red-400 px-1.5 py-0.5 rounded uppercase tracking-wider font-bold">Threats</span>
                            </h3>
                            <span class="bg-slate-200 dark:bg-slate-700 text-xs px-2 py-0.5 rounded font-mono text-slate-600 dark:text-slate-300">{{ list.items.length }}</span>
                        </div>
                        
                        <div class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-2">
                            <div v-for="(item, index) in list.items" :key="index" class="p-3 bg-slate-50 dark:bg-slate-900/30 rounded-lg border border-transparent hover:border-indigo-500/30 group transition-all">
                                <div class="flex flex-col gap-1 mb-1">
                                    <div class="flex justify-between items-start">
                                        
                                        <div class="flex flex-col">
                                            <span class="font-mono text-sm text-indigo-600 dark:text-indigo-400 font-bold break-all">{{ item.val }}</span>
                                            <span v-if="getOrigin(item.note)" class="text-[9px] bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-1.5 py-0.5 rounded w-fit mt-1 font-bold">
                                                From: {{ getOrigin(item.note) }}
                                            </span>
                                        </div>
                                        
                                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                            
                                            <button v-if="key !== 'BLOCKED_THREATS'" @click="openModal('BLOCK', key, index, item)" class="text-slate-400 hover:text-red-500 px-1" title="Block this item">‚õî</button>
                                            
                                            <button v-if="key === 'BLOCKED_THREATS'" @click="openModal('RESTORE', key, index, item)" class="text-slate-400 hover:text-emerald-500 px-1" title="Restore this item">‚ôªÔ∏è</button>
                                            
                                            <button @click="deleteItem(key, index, item)" class="text-slate-400 hover:text-red-500 px-1" title="Delete permanently">‚úï</button>
                                        </div>
                                    </div>
                                </div>
                                <textarea v-model="item.note" @input="markDirty" class="w-full bg-transparent text-[11px] text-slate-500 dark:text-slate-400 focus:text-slate-800 dark:focus:text-slate-200 border-none p-0 outline-none resize-none placeholder-slate-400 dark:placeholder-slate-600" rows="1" placeholder="Add note..."></textarea>
                            </div>
                        </div>

                        <div class="p-3 bg-slate-100 dark:bg-slate-900 border-t border-slate-200 dark:border-slate-700">
                            <div class="flex gap-2 mb-2">
                                <input v-model="inputs[key].val" @keyup.enter="addItem(key)" class="flex-1 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded px-3 py-2 text-xs font-mono outline-none focus:border-indigo-500 text-slate-800 dark:text-white" :placeholder="list.placeholder">
                            </div>
                            <div class="flex gap-2">
                                <input v-model="inputs[key].note" @keyup.enter="addItem(key)" class="flex-1 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded px-3 py-2 text-xs outline-none focus:border-indigo-500 text-slate-800 dark:text-white" placeholder="Optional Note...">
                                <button @click="addItem(key)" class="bg-indigo-600 hover:bg-indigo-700 text-white rounded px-3 py-2 text-xs font-bold">Add</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentView === 'whitelist-readme'" class="flex-1 overflow-y-auto p-6 relative">
                <div v-if="totalItems === 0" class="flex flex-col items-center justify-center h-full text-slate-400 opacity-60">
                    <div class="text-4xl mb-4">üìù</div>
                    <h3 class="font-bold text-sm mb-1">Documentation Empty</h3>
                </div>
                <div v-else class="max-w-4xl mx-auto bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl p-8 markdown-body shadow-sm dark:shadow-lg transition-colors duration-300" v-html="renderedReadme"></div>
            </div>

            <div v-if="currentView.includes('-json') || currentView.includes('-log')" class="flex-1 overflow-hidden flex flex-col bg-slate-50 dark:bg-slate-950 relative transition-colors duration-300">
                <div v-if="loadingLog" class="absolute inset-0 flex items-center justify-center bg-slate-50 dark:bg-slate-950 z-20">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"></div>
                </div>
                <div v-else-if="!activeLogContent || activeLogContent.trim() === ''" class="flex flex-col items-center justify-center h-full text-slate-500 z-10">
                    <div class="text-4xl mb-4 grayscale opacity-50">üìÇ</div>
                    <h3 class="font-bold text-sm mb-1">File Empty or Missing</h3>
                </div>
                <div v-else class="flex-1 overflow-y-auto p-4 custom-scrollbar">
                    <pre v-if="currentView.includes('-json')" class="font-mono text-xs text-emerald-600 dark:text-emerald-400 whitespace-pre-wrap">{{ activeLogContent }}</pre>
                    <pre v-else class="font-mono text-xs whitespace-pre-wrap" v-html="formattedLogContent"></pre>
                </div>
            </div>

        </main>
    </div>
</div>

<script type="module">
    import { Octokit } from "https://esm.sh/@octokit/core";
    const { createApp } = Vue;

    // --- CONFIGURATION ---
    const TARGET_OWNER = 'malaareda'; 
    const TARGET_REPO  = 'security-list';         
    const FILE_TEMP    = 'security-list-backup/security-whitelist-backup/security-whitelist-temp.json';
    const FILE_README  = 'security-list-backup/security-whitelist-backup/README.md';

    const JSON_FILES = {
        'whitelist': 'security-list-backup/security-whitelist-backup/security-whitelist-R.00.json',
        'blacklist': 'security-list-backup/security-blacklist-backup/security-blacklist-R.00.json',
        'livelist':  'security-list-backup/security-live-blacklist-backup/security-live-blacklist-R.00.json'
    };

    const LOGS = {
        'whitelist': 'security-list-backup/security-whitelist-backup/whitelist-security-audit.log',
        'blacklist': 'security-list-backup/security-blacklist-backup/blacklist-security-audit.log',
        'livelist':  'security-list-backup/security-live-blacklist-backup/live-blacklist-security-audit.log'
    };
    
    // Status colors for Logs
    const STATUS_CONFIG = {
        SUCCESS: { label: 'SUCCESS', hex: '#16a34a' },
        INFO:    { label: 'INFO',    hex: '#2563eb' },
        WARN:    { label: 'WARNING', hex: '#d97706' },
        ERROR:   { label: 'ERROR',   hex: '#dc2626' },
        PROCESS: { label: 'PROCESS', hex: '#0891b2' },
        START:   { label: 'START',   hex: '#9333ea' },
        CLEANUP: { label: 'CLEANUP', hex: '#4b5563' }
    };

    const INACTIVITY_MINUTES = 10; 

    createApp({
        data() {
            return {
                isInitializing: true,
                token: localStorage.getItem('gh_token') || '',
                tokenInput: '',
                loading: false,
                loadingLog: false,
                sidebarOpen: false,
                targetRepo: `${TARGET_OWNER}/${TARGET_REPO}`,
                isDark: true,
                currentView: 'whitelist-update',
                targetTime: 0,
                timeLeft: INACTIVITY_MINUTES * 60,
                countdownInterval: null,
                hasUnsavedChanges: false,
                activeLogContent: '',
                toast: { show: false, title: '', message: '', isError: false },
                
                // --- ADVANCED MODAL STATE ---
                modal: { show: false, type: '', sourceKey: '', index: null, val: '', reason: '', targetKey: '' },

                sessionHistory: [], 
                existingReadmeContent: '',

                editableLists: {
                    GOOD_IPS:        { title: 'üåç Allowed IPs',      placeholder: 'IP Address...', items: [] },
                    BLOCKED_THREATS: { title: '‚õî Blocked Threats',  placeholder: 'IP / UA / Domain...', items: [] },
                    GOOD_REFERRERS:  { title: 'üîó Referrers',        placeholder: 'Domain...',     items: [] },
                    SEARCH_BOTS:     { title: 'ü§ñ Search Bots',      placeholder: 'User-Agent...', items: [] },
                    AI_BOTS:         { title: 'üß† AI Agents',        placeholder: 'User-Agent...', items: [] }
                },
                inputs: {
                    GOOD_IPS: { val: '', note: '' },
                    BLOCKED_THREATS: { val: '', note: '' },
                    GOOD_REFERRERS: { val: '', note: '' },
                    SEARCH_BOTS: { val: '', note: '' },
                    AI_BOTS: { val: '', note: '' }
                }
            }
        },
        computed: {
            formattedTime() {
                const total = Math.max(0, this.timeLeft);
                const m = Math.floor(total / 60).toString().padStart(2, '0');
                const s = (total % 60).toString().padStart(2, '0');
                return `${m}:${s}`;
            },
            renderedReadme() { 
                return marked.parse(this.generateReadmeContent(true)); 
            },
            totalItems() {
                let count = 0;
                for (const key in this.editableLists) count += this.editableLists[key].items.length;
                return count;
            },
            formattedLogContent() {
                if (!this.activeLogContent) return '';
                const lines = this.activeLogContent.split('\n');
                return lines.map(line => {
                    const safeLine = line.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    // Header detection
                    if (safeLine.startsWith('====') || safeLine.startsWith('----') || safeLine.includes('[SESSION:')) {
                        return `<span class="text-slate-900 dark:text-yellow-400 font-bold">${safeLine}</span>`;
                    }
                    // Color detection
                    let matchedColor = null;
                    for (const key in STATUS_CONFIG) {
                        const config = STATUS_CONFIG[key];
                        if (safeLine.includes(config.label)) { matchedColor = config.hex; break; }
                    }
                    if (matchedColor) return `<span style="color: ${matchedColor}; font-weight: 600;">${safeLine}</span>`;
                    return `<span class="text-slate-600 dark:text-slate-400">${safeLine}</span>`;
                }).join('\n');
            }
        },
        mounted() {
            this.initTheme();
            if (this.token) { this.loadWhitelistData(); this.startCountdown(); } 
            else { this.isInitializing = false; }
            ['mousemove','keydown','click'].forEach(e => window.addEventListener(e, this.resetActivity));
        },
        methods: {
            initTheme() {
                const savedTheme = localStorage.getItem('theme');
                this.isDark = savedTheme ? savedTheme === 'dark' : true; 
                this.applyTheme();
            },
            toggleTheme() {
                this.isDark = !this.isDark;
                localStorage.setItem('theme', this.isDark ? 'dark' : 'light');
                this.applyTheme();
            },
            applyTheme() {
                if (this.isDark) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            },
            showToast(title, message, isError = false) {
                this.toast = { show: true, title, message, isError };
                setTimeout(() => { this.toast.show = false; }, 4000);
            },
            
            // --- AUTH ---
            setToken() {
                if(!this.tokenInput.trim()) return;
                this.token = this.tokenInput;
                localStorage.setItem('gh_token', this.token);
                this.loadWhitelistData();
                this.startCountdown();
            },
            logout() {
                this.token = '';
                localStorage.removeItem('gh_token');
                clearInterval(this.countdownInterval);
                this.isInitializing = false;
            },
            startCountdown() {
                this.resetActivity();
                if (this.countdownInterval) clearInterval(this.countdownInterval);
                this.countdownInterval = setInterval(() => {
                    const now = Date.now();
                    this.timeLeft = Math.ceil((this.targetTime - now) / 1000);
                    if (this.timeLeft <= 0) this.logout();
                }, 1000);
            },
            resetActivity() {
                if (!this.token) return;
                this.targetTime = Date.now() + (INACTIVITY_MINUTES * 60 * 1000);
            },
            markDirty() { this.hasUnsavedChanges = true; this.resetActivity(); },

            // --- DATA LOADERS ---
            async loadWhitelistData() {
                this.loading = true;
                const octokit = new Octokit({ auth: this.token });
                try {
                    const jsonRes = await octokit.request(`GET /repos/${TARGET_OWNER}/${TARGET_REPO}/contents/${JSON_FILES['whitelist']}`);
                    const jsonData = JSON.parse(decodeURIComponent(escape(atob(jsonRes.data.content))));
                    try {
                        const readmeRes = await octokit.request(`GET /repos/${TARGET_OWNER}/${TARGET_REPO}/contents/${FILE_README}`);
                        this.existingReadmeContent = decodeURIComponent(escape(atob(readmeRes.data.content)));
                    } catch (e) { this.existingReadmeContent = ''; }
                    this.mergeData(jsonData, this.existingReadmeContent);
                    this.isInitializing = false;
                    this.hasUnsavedChanges = false;
                } catch (e) {
                    console.error(e);
                    this.showToast('Login Failed', e.message, true);
                    this.logout();
                } finally { this.loading = false; }
            },

            mergeData(json, readme) {
                const noteMap = {};
                const lines = readme.split('\n');
                lines.forEach(line => {
                    const match = line.match(/- `(.*?)` \| üìù (.*)/);
                    if(match) noteMap[match[1]] = match[2];
                });
                const populate = (key, sourceArr) => {
                    this.editableLists[key].items = (sourceArr || []).map(val => ({
                        val: val,
                        note: noteMap[val] || '' 
                    }));
                };
                populate('GOOD_IPS', json.GOOD_IPS);
                populate('BLOCKED_THREATS', json.BLOCKED_THREATS || json.BLOCKED_IPS);
                populate('GOOD_REFERRERS', json.GOOD_REFERRERS);
                populate('SEARCH_BOTS', json.GOOD_BOTS?.SEARCH_BOTS);
                populate('AI_BOTS', json.GOOD_BOTS?.AI_BOTS);
            },

            async loadLog(type) {
                this.currentView = type + '-log';
                this.activeLogContent = '';
                this.loadingLog = true;
                const octokit = new Octokit({ auth: this.token });
                try {
                    const path = LOGS[type];
                    const res = await octokit.request(`GET /repos/${TARGET_OWNER}/${TARGET_REPO}/contents/${path}`);
                    let content = decodeURIComponent(escape(atob(res.data.content)));
                    this.activeLogContent = content;
                } catch (e) {
                    if (e.status !== 404) this.activeLogContent = `Error: ${e.message}`;
                } finally { this.loadingLog = false; }
            },

            async loadJson(type) {
                this.currentView = type + '-json';
                this.activeLogContent = '';
                this.loadingLog = true;
                const octokit = new Octokit({ auth: this.token });
                try {
                    const path = JSON_FILES[type];
                    const res = await octokit.request(`GET /repos/${TARGET_OWNER}/${TARGET_REPO}/contents/${path}`);
                    const content = decodeURIComponent(escape(atob(res.data.content)));
                    this.activeLogContent = JSON.stringify(JSON.parse(content), null, 4);
                } catch (e) {
                    if (e.status !== 404) this.activeLogContent = `Error: ${e.message}`;
                } finally { this.loadingLog = false; }
            },

            // --- UI HELPER: EXTRACT TAG FROM NOTE ---
            getOrigin(note) {
                if(!note) return null;
                const match = note.match(/\[Origin: (.*?)\]/);
                if(match) {
                    const key = match[1];
                    const list = this.editableLists[key];
                    return list ? list.title.replace(/^[^\s]+\s/, '') : key; 
                }
                return null;
            },

            // --- CORE ITEM MANAGEMENT ---
            addItem(key) {
                const val = this.inputs[key].val.trim();
                const note = this.inputs[key].note.trim();
                if (!val) return;
                
                if (key === 'BLOCKED_THREATS' && !note) {
                    this.showToast('Validation Error', 'You must add a note explaining why this threat is blocked.', true);
                    return;
                }

                this.editableLists[key].items.unshift({ val, note });
                this.inputs[key].val = '';
                this.inputs[key].note = '';
                
                if (key === 'BLOCKED_THREATS') {
                    this.sessionHistory.push({ action: 'ADDED', val, note, date: new Date().toISOString().split('T')[0] });
                }
                this.markDirty();
            },

            // [FIXED] Updated signature to accept 'item'
            deleteItem(key, index, item) {
                // Intercept deletion for threats to enforce audit log via Modal
                if (key === 'BLOCKED_THREATS') {
                    // Redirect to the modal flow as a RESTORE/UNBLOCK action
                    this.openModal('RESTORE', key, index, item);
                    return;
                }

                // Standard delete for other lists
                this.editableLists[key].items.splice(index, 1);
                this.markDirty();
            },

            // --- ADVANCED MODAL ACTIONS ---
            openModal(type, key, index, item) {
                let targetKey = '';
                
                // Determine Initial Note for Modal:
                // 1. BLOCKING: Empty string (Force user to type reason)
                // 2. RESTORING: Empty string (Force user to type reason)
                // We deliberately do NOT pre-fill 'item.note' so the user must justify the action again.
                const initialReason = ''; 

                if(type === 'RESTORE') {
                    const originMatch = item.note ? item.note.match(/\[Origin: (.*?)\]/) : null;
                    if(originMatch && this.editableLists[originMatch[1]]) {
                        targetKey = originMatch[1];
                    }
                }
                
                this.modal = { show: true, type, sourceKey: key, index, val: item.val, reason: initialReason, targetKey };
            },
            
            closeModal() { this.modal.show = false; },
            
            confirmAction() {
                if(!this.modal.reason.trim()) {
                    this.showToast('Missing Reason', 'Audit log requires a reason.', true);
                    return;
                }
                
                // 1. Remove from Source
                const removedItem = this.editableLists[this.modal.sourceKey].items.splice(this.modal.index, 1)[0];

                if (this.modal.type === 'BLOCK') {
                    // MOVE TO BLOCKED_THREATS (WITH TAG)
                    const newNote = `[Origin: ${this.modal.sourceKey}] ${this.modal.reason}`;
                    this.editableLists.BLOCKED_THREATS.items.unshift({ val: this.modal.val, note: newNote });
                    
                    this.sessionHistory.push({
                        action: 'BLOCKED', 
                        val: this.modal.val, 
                        note: `Source: ${this.modal.sourceKey} | ${this.modal.reason}`, 
                        date: new Date().toISOString().split('T')[0]
                    });
                } else {
                    // RESTORE
                    if (this.modal.targetKey) {
                        // Restore to specific list, note is just the reason (no tag needed)
                        this.editableLists[this.modal.targetKey].items.unshift({ val: this.modal.val, note: this.modal.reason });
                        
                        this.sessionHistory.push({
                            action: 'RESTORED', 
                            val: this.modal.val, 
                            note: `Restored to ${this.modal.targetKey} | ${this.modal.reason}`, 
                            date: new Date().toISOString().split('T')[0]
                        });
                    } else {
                        // Just Unblock
                        this.sessionHistory.push({
                            action: 'UNBLOCKED', 
                            val: this.modal.val, 
                            note: this.modal.reason, 
                            date: new Date().toISOString().split('T')[0]
                        });
                    }
                }
                this.markDirty();
                this.closeModal();
            },

            generateReadmeContent(isPreview = false) {
                let md = `# üõ°Ô∏è Security Whitelist Documentation\n\n`;
                md += `**Last Updated:** ${new Date().toUTCString()}\n\n`;
                md += `> This file is auto-generated by the Security Manager WebUI. It contains record details and notes.\n\n`;
                
                const sections = [
                    { key: 'GOOD_IPS', title: 'üåç Allowed IPs' },
                    { key: 'BLOCKED_THREATS', title: '‚õî Blocked Threats' },
                    { key: 'GOOD_REFERRERS', title: 'üîó Referrers' },
                    { key: 'SEARCH_BOTS', title: 'ü§ñ Search Bots' },
                    { key: 'AI_BOTS', title: 'üß† AI Agents' }
                ];

                sections.forEach(sec => {
                    md += `## ${sec.title}\n`;
                    const items = this.editableLists[sec.key].items;
                    if(items.length === 0) md += `*No records.*\n\n`;
                    else {
                        items.forEach(item => {
                            const noteStr = item.note ? ` | üìù ${item.note}` : '';
                            md += `- \`${item.val}\`${noteStr}\n`;
                        });
                        md += `\n`;
                    }
                });

                const historyHeader = `## üìú Threat History (Permanent Log)`;
                let historyContent = "";
                
                if (this.existingReadmeContent && this.existingReadmeContent.includes(historyHeader)) {
                    const parts = this.existingReadmeContent.split(historyHeader);
                    if (parts[1]) historyContent = parts[1].trim();
                }

                if (this.sessionHistory.length > 0) {
                    const newLogLines = this.sessionHistory.map(h => {
                        let icon = '‚ö™';
                        if (h.action === 'ADDED' || h.action === 'BLOCKED') icon = 'üî¥';
                        else if (h.action === 'REMOVED' || h.action === 'UNBLOCKED' || h.action === 'RESTORED') icon = 'üü¢';
                        
                        return `- ${icon} [${h.date}] **${h.action}**: \`${h.val}\` | Reason: *${h.note}*`;
                    }).join('\n');
                    
                    historyContent = historyContent ? (historyContent + '\n' + newLogLines) : newLogLines;
                }

                md += `\n${historyHeader}\n${historyContent || '*No history yet.*'}\n`;
                return md;
            },

            async saveChanges() {
                this.loading = true;
                const octokit = new Octokit({ auth: this.token });
                try {
                    const jsonPayload = {
                        GOOD_IPS: this.editableLists.GOOD_IPS.items.map(i => i.val),
                        BLOCKED_THREATS: this.editableLists.BLOCKED_THREATS.items.map(i => i.val),
                        GOOD_REFERRERS: this.editableLists.GOOD_REFERRERS.items.map(i => i.val),
                        GOOD_BOTS: {
                            SEARCH_BOTS: this.editableLists.SEARCH_BOTS.items.map(i => i.val),
                            AI_BOTS: this.editableLists.AI_BOTS.items.map(i => i.val)
                        }
                    };
                    const readmePayload = this.generateReadmeContent(false);

                    let shaTemp = null;
                    try { 
                        const res = await octokit.request(`GET /repos/${TARGET_OWNER}/${TARGET_REPO}/contents/${FILE_TEMP}`); 
                        shaTemp = res.data.sha; 
                    } catch(e) {}

                    await octokit.request(`PUT /repos/${TARGET_OWNER}/${TARGET_REPO}/contents/${FILE_TEMP}`, {
                        message: 'üõ°Ô∏è Update Whitelist (WebUI)',
                        content: btoa(unescape(encodeURIComponent(JSON.stringify(jsonPayload, null, 2)))),
                        sha: shaTemp
                    });

                    let shaReadme = null;
                    try { 
                        const res = await octokit.request(`GET /repos/${TARGET_OWNER}/${TARGET_REPO}/contents/${FILE_README}`); 
                        shaReadme = res.data.sha; 
                    } catch(e) {}

                    await octokit.request(`PUT /repos/${TARGET_OWNER}/${TARGET_REPO}/contents/${FILE_README}`, {
                        message: 'üìù Update Documentation & History',
                        content: btoa(unescape(encodeURIComponent(readmePayload))),
                        sha: shaReadme
                    });

                    this.hasUnsavedChanges = false;
                    this.sessionHistory = []; 
                    this.existingReadmeContent = readmePayload; 
                    this.resetActivity();
                    this.showToast('Success', 'Changes committed successfully.');
                } catch (e) {
                    console.error(e);
                    this.showToast('Save Failed', e.message, true);
                } finally { this.loading = false; }
            }
        }
    }).mount('#app');
</script>
</body>
</html>
